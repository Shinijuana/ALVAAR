<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <title>AlvaAR Camera</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <style>
        /* (Stile omesso per brevit√†) */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
<div id="container"></div>
<div id="overlay">
    <button id="start_button">Start</button>
    <div id="splash"></div>
</div>
<script type="module">
    import { Stats } from "./assets/stats.js";
    import { AlvaAR } from './assets/alva_ar.js';
    import { ARCamView } from "./assets/view.js";
    import { Camera, onFrame, resize2cover } from "./assets/utils.js";

    // Crea un'istanza di GLTFLoader
    const loader = new THREE.GLTFLoader();

    function main() {
        const config = {
            video: {
                facingMode: 'environment',
                aspectRatio: 16 / 9,
                width: { ideal: 1280 }
            },
            audio: false
        }

        const $container = document.getElementById('container');
        const $view = document.createElement('div');
        const $canvas = document.createElement('canvas');
        const $overlay = document.getElementById('overlay');
        const $start = document.getElementById('start_button');
        const $splash = document.getElementById('splash');
        const splashFadeTime = 800;

        $splash.style.transition = `opacity ${splashFadeTime / 1000}s ease`;
        $splash.style.opacity = 0;

        async function demo(media) {
            const $video = media.el;

            const size = resize2cover($video.videoWidth, $video.videoHeight, $container.clientWidth, $container.clientHeight);

            $canvas.width = $container.clientWidth;
            $canvas.height = $container.clientHeight;
            $video.style.width = size.width + 'px';
            $video.style.height = size.height + 'px';

            const ctx = $canvas.getContext('2d', { alpha: false, desynchronized: true });
            const alva = await AlvaAR.Initialize($canvas.width, $canvas.height);
            const view = new ARCamView($view, $canvas.width, $canvas.height);

            // Carica il modello GLB
            loader.load('ASTRONAVE.glb', (gltf) => {
                const model = gltf.scene;
                view.scene.add(model); // Aggiungi il modello alla scena
            }, undefined, (error) => {
                console.error(error);
            });

            Stats.add('total');
            Stats.add('video');
            Stats.add('slam');

            $container.appendChild($canvas);
            $container.appendChild($view);

            document.body.appendChild(Stats.el);
            document.body.addEventListener("click", () => alva.reset(), false);

            onFrame(() => {
                Stats.next();
                Stats.start('total');

                ctx.clearRect(0, 0, $canvas.width, $canvas.height);

                if (!document['hidden']) {
                    Stats.start('video');
                    ctx.drawImage($video, 0, 0, $video.videoWidth, $video.videoHeight, size.x, size.y, size.width, size.height);
                    const frame = ctx.getImageData(0, 0, $canvas.width, $canvas.height);
                    Stats.stop('video');

                    Stats.start('slam');
                    const pose = alva.findCameraPose(frame);
                    Stats.stop('slam');

                    if (pose) {
                        view.updateCameraPose(pose);
                    } else {
                        view.lostCamera();
                        const dots = alva.getFramePoints();

                        for (const p of dots) {
                            ctx.fillStyle = 'white';
                            ctx.fillRect(p.x, p.y, 2, 2);
                        }
                    }
                }

                Stats.stop('total');
                Stats.render();

                return true;
            }, 30);
        }

        setTimeout(() => {
            $splash.remove();

            $start.addEventListener('click', () => {
                $overlay.remove();

                Camera.Initialize(config).then(media => demo(media)).catch(error => alert('Camera ' + error));

            }, { once: true });

        }, splashFadeTime);
    }

    window.addEventListener('load', main);
</script>
</body>
</html>
