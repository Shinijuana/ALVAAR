<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <title>AlvaAR Camera</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <style>
        /* Stili CSS come prima */
    </style>
</head>
<body>
<div id="container"></div>
<div id="overlay">
    <button id="start_button">Start</button>
    <div id="splash"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script type="module">
    import { Stats } from "./assets/stats.js";
    import { AlvaAR } from './assets/alva_ar.js';
    import { ARCamView } from "./assets/view.js";
    import { Camera, onFrame, resize2cover } from "./assets/utils.js";

    // Global variables
    let scene, camera, renderer, model;
    let pose = null;  // Dichiarazione della variabile 'pose'

    // Function to load the .glb model
    function loadModel() {
        const loader = new THREE.GLTFLoader();
        loader.load('ASTRONAVE.glb', function (gltf) {
            model = gltf.scene;
            scene.add(model);

            // Set the position and scale of the model
            model.position.set(0, 0, -10);  // Default position
            model.scale.set(0.5, 0.5, 0.5);  // Adjust scale if necessary
        });
    }

    // Initialize Three.js scene
    function initScene() {
        scene = new THREE.Scene();

        // Set up camera
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
        camera.position.set(0, 0, 0);

        // Set up renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Load the model
        loadModel();
    }

    // Animation loop to render the scene and update the model position
    function animate() {
        requestAnimationFrame(animate);

        // Update model position and rotation based on the camera pose
        if (model && pose) {
            model.position.set(pose.x, pose.y, pose.z);
            model.rotation.set(pose.rotation.x, pose.rotation.y, pose.rotation.z);
        }

        renderer.render(scene, camera);
    }

    // Main function to initialize the AR environment
    function main() {
        const config = {
            video: {
                facingMode: 'environment',
                aspectRatio: 16 / 9,
                width: { ideal: 1280 }
            },
            audio: false
        }

        const $container = document.getElementById('container');
        const $view = document.createElement('div');
        const $canvas = document.createElement('canvas');
        const $overlay = document.getElementById('overlay');
        const $start = document.getElementById('start_button');
        const $splash = document.getElementById('splash');
        const splashFadeTime = 800;

        $splash.style.transition = `opacity ${splashFadeTime / 1000}s ease`;
        $splash.style.opacity = 0;

        async function demo(media) {
            const $video = media.el;

            const size = resize2cover($video.videoWidth, $video.videoHeight, $container.clientWidth, $container.clientHeight);

            $canvas.width = $container.clientWidth;
            $canvas.height = $container.clientHeight;
            $video.style.width = size.width + 'px';
            $video.style.height = size.height + 'px';

            const ctx = $canvas.getContext('2d', { alpha: false, desynchronized: true });
            const alva = await AlvaAR.Initialize($canvas.width, $canvas.height);
            const view = new ARCamView($view, $canvas.width, $canvas.height);

            Stats.add('total');
            Stats.add('video');
            Stats.add('slam');

            $container.appendChild($canvas);
            $container.appendChild($view);

            document.body.appendChild(Stats.el);
            document.body.addEventListener("click", () => alva.reset(), false);

            onFrame(() => {
                Stats.next();
                Stats.start('total');

                ctx.clearRect(0, 0, $canvas.width, $canvas.height);

                if (!document['hidden']) {
                    Stats.start('video');
                    ctx.drawImage($video, 0, 0, $video.videoWidth, $video.videoHeight, size.x, size.y, size.width, size.height);
                    const frame = ctx.getImageData(0, 0, $canvas.width, $canvas.height);
                    Stats.stop('video');

                    Stats.start('slam');
                    // Aggiorna la variabile 'pose' con i dati della fotocamera
                    pose = alva.findCameraPose(frame);
                    Stats.stop('slam');

                    if (pose) {
                        view.updateCameraPose(pose);

                        // Update 3D model position with the camera pose
                        if (model) {
                            model.position.set(pose.x, pose.y, pose.z);
                            model.rotation.set(pose.rotation.x, pose.rotation.y, pose.rotation.z);
                        }
                    } else {
                        view.lostCamera();

                        const dots = alva.getFramePoints();

                        for (const p of dots) {
                            ctx.fillStyle = 'white';
                            ctx.fillRect(p.x, p.y, 2, 2);
                        }
                    }
                }

                Stats.stop('total');
                Stats.render();

                return true;
            }, 30);
        }

        setTimeout(() => {
            $splash.remove();

            $start.addEventListener('click', () => {
                $overlay.remove();

                Camera.Initialize(config, demo);
            });
        }, splashFadeTime);
    }

    // Start the AR experience
    main();

    // Initialize Three.js scene
    initScene();

    // Start animation loop
    animate();
</script>
</body>
</html>
